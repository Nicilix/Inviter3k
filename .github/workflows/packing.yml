name: Package Addon

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Determine package name
        id: meta
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            PKG="${GITHUB_REF#refs/tags/}"
          else
            PKG="Inviter3k-${GITHUB_SHA::7}"
          fi
          echo "pkg=${PKG}" >> $GITHUB_OUTPUT

      - name: Create staging and copy addon files
        id: stage
        run: |
          STAGE="$(mktemp -d)"
          ADDON_DIR="${STAGE}/Inviter3k"
          mkdir -p "$ADDON_DIR"
          cp -r Libs "$ADDON_DIR/" 2>/dev/null || true
          cp -r Lua "$ADDON_DIR/" 2>/dev/null || cp -r lua "$ADDON_DIR/" 2>/dev/null || true
          cp icon.tga "$ADDON_DIR/" 2>/dev/null || true
          cp Inviter3k.lua "$ADDON_DIR/" 2>/dev/null || true
          cp Inviter3k.toc "$ADDON_DIR/" 2>/dev/null || true
          # debug: show what's in staging
          echo "Staging contents:"
          ls -la "$ADDON_DIR" || true
          echo "stage=$STAGE" >> $GITHUB_OUTPUT

      - name: Create ZIP outside repo then move into .release
        id: zip
        run: |
          PKG="${{ steps.meta.outputs.pkg }}"
          STAGEDIR="${{ steps.stage.outputs.stage }}"
          if [ -z "$STAGEDIR" ]; then
            echo "Missing staging dir; aborting"
            exit 1
          fi
          TMPZIP="/tmp/${PKG}.zip"
          # create zip so archive root is Inviter3k/
          (cd "$STAGEDIR" && zip -r "$TMPZIP" Inviter3k > /dev/null)
          mkdir -p .release
          mv "$TMPZIP" ".release/${PKG}.zip"
          echo "zip_path=.release/${PKG}.zip" >> $GITHUB_OUTPUT


      - name: Show .release contents
        run: ls -la .release || true

      - name: Upload addon zip as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Inviter3k-package
          path: ${{ steps.zip.outputs.zip_path }}


