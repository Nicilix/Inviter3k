name: Package Addon

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Determine package name
        id: meta
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            PKG="${GITHUB_REF#refs/tags/}"
          else
            PKG="Inviter3k-${GITHUB_SHA::7}"
          fi
          echo "pkg=${PKG}" >> $GITHUB_OUTPUT

      - name: Create staging and copy addon files
        run: |
          STAGE="$(mktemp -d)"
          ADDON_DIR="${STAGE}/Inviter3k"
          mkdir -p "$ADDON_DIR"
          # Copy the addon files/folders you want included
          # Adjust the list if your addon has additional items
          cp -r Libs "$ADDON_DIR/" 2>/dev/null || true
          cp icon.tga "$ADDON_DIR/" 2>/dev/null || true
          cp Inviter3k.lua "$ADDON_DIR/" 2>/dev/null || true
          cp Inviter3k.toc "$ADDON_DIR/" 2>/dev/null || true
          # optional: copy README or other files required by CurseForge
          # cp README.txt "$ADDON_DIR/" 2>/dev/null || true
          echo "stage=$STAGE" >> $GITHUB_OUTPUT

      - name: Create ZIP outside repo then move into .release
        id: zip
        run: |
          PKG="${{ steps.meta.outputs.pkg }}"
          STAGE="${{ steps.meta.outputs.stage }}" || STAGE="${{ steps.meta.outputs.stage }}"
          # use the stage created in the previous step
          STAGEDIR=$(mktemp -d)
          # If stage path was written to outputs, prefer it:
          if [ -n "${{ steps.meta.outputs.stage }}" ]; then
            STAGEDIR="${{ steps.meta.outputs.stage }}"
          else
            echo "No explicit stage output found; creating new staging dir"
            STAGEDIR="$(mktemp -d)"
          fi
          # create zip from the staged addon folder so the archive root is Inviter3k/
          TMPZIP="/tmp/${PKG}.zip"
          (cd "$(dirname "$STAGEDIR")" && zip -r "$TMPZIP" "$(basename "$STAGEDIR")/Inviter3k" > /dev/null)
          mkdir -p .release
          mv "$TMPZIP" ".release/${PKG}.zip"
          echo "zip_path=.release/${PKG}.zip" >> $GITHUB_OUTPUT

      - name: Show .release contents
        run: ls -la .release || true

      - name: Upload addon zip as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Inviter3k-package
          path: ${{ steps.zip.outputs.zip_path }}


